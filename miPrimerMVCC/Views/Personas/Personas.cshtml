@model Web100.Models.ViewModel.RegistroPersona
@{
    ViewBag.Title = "Detalles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Scripts/jquery-3.4.1.min.js"></script>

<script type="text/javascript">

    $(document).ready(function ()
    {
        ObtienePersonas();
    });
    
    function Botones(Bandera)
    {
        if (Bandera == 1) {
            document.getElementById('ConfirmarAgregar').style.display = 'inline';
            document.getElementById('ConfirmarEditar').style.display = 'none';
        }
        else
        {
            document.getElementById('ConfirmarAgregar').style.display = 'none';
            document.getElementById('ConfirmarEditar').style.display = 'inline';
        }
    }

    function Check()
    {
        if (document.getElementById('Estatus').checked == true)
        {
            document.getElementById('Estatus').value = true;
        }
        else
        {
            document.getElementById('Estatus').value = false;
        }
    }

    function ValidaControles()
    {
        var isValid = true;
        if ($('#Nombre').val().trim() == "")
        {
            $('#Nombre').css('border-color', 'Red');
            isValid = false;
        }
        else {
            $('#Nombre').css('border-color', 'lightgrey');
        }

        if ($('#ApellidoPaterno').val().trim() == "")
        {
            $('#ApellidoPaterno').css('border-color', 'Red');
            isValid = false;
        }
        else
        {
            $('#ApellidoPaterno').css('border-color', 'lightgrey');
        }

        if ($('#ApellidoMaterno').val().trim() == "")
        {
            $('#ApellidoMaterno').css('border-color', 'Red');
            isValid = false;
        }
        else
        {
            $('#ApellidoMaterno').css('border-color', 'lightgrey');
        }

        return isValid;
    }

    function Limpiar()
    {
        $('#Nombre').val("");
        $('#ApellidoPaterno').val("");
        $('#ApellidoMaterno').val("");

        $('#Nombre').css('border-color', 'lightgrey');
        $('#ApellidoPaterno').css('border-color', 'lightgrey');
        $('#ApellidoMaterno').css('border-color', 'lightgrey');

        Botones(1);
    }

    function ObtienePersonas()
    {
        $.ajax({
            url: "/Personas/ListaPersonas",
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                var html = '';
                $.each(result, function (key, item) {

                    var estatus = '';
                    if (item.Estatus == true) { estatus = 'Activo' } else { estatus = 'Inactivo' }

                    html += '<tr>';
                    html += '<td>' + item.Id + '</td>';
                    html += '<td>' + item.Nombre + '</td>';
                    html += '<td>' + item.ApellidoPaterno + '</td>';
                    html += '<td>' + item.ApellidoMaterno + '</td>';
                    html += '<td>' + estatus + '</td>';
                    html += '<td><button type="button" class="btn btn-primary" id="Editar" onclick="ObtienePersona(' + item.Id + ');">Editar</button> | <button type="button" class="btn btn-danger" id="Eliminar" onclick="ConfimarEliminacion(' + item.Id + ');">Eliminar</button >';
                    html += '</tr>';
                });
                $('.tbody').html(html);
            },
            error: function (errormessage) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Error al cargar datos ' + errormessage.responseText,
                    footer: '<a href>Ayuda</a>'
                })

            }
        });
    }

    function ConfimarEliminacion(Id)
    {
        Swal.fire({
                title: "Registro " + Id,
                text: "¿Eliminar?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar",
            })
            .then(resultado =>
            {
                if (resultado.isConfirmed){ Eliminar(Id); }
                else { ObtienePersonas(); }
            });
    }

    function Eliminar(Id)
    {
        fetch("@Url.Content("~/Personas/EliminarPersona")",
            {
                method: "POST",
                body: JSON.stringify({ Id: Id }),
                headers: {
                    'Accept': "application/json",
                    "Content-Type": "application/json"
                }
            })
            .then(function (response)
            {
                if (response.ok)
                {
                    return response.text();
                }
                else
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'Algo salio mal al conectar',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            })
            .then(function (Data)
            {
                if (Data == "1")
                {
                    Swal.fire({
                        icon: 'success',
                        title: 'Registro Eliminado Correctamente',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    ObtienePersonas();
                }
                else
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'Algo salio mal. Error' + Data,
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            })

    }

    function Eliminar2(Id) {

        $.ajax({
            url: "@Url.Content("~/Personas/EliminarPersona")",
            type: "POST",
            data: JSON.stringify({ Id: Id }),
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: function (result) {
                Swal.fire({
                    icon: 'success',
                    title: 'Registro Eliminado Correctamente',
                    showConfirmButton: false,
                    timer: 2000
                });
                ObtienePersonas();
            },
            error: function (errormessage) {
                Swal.fire({
                    icon: 'error',
                    title: 'Algo salio mal. Error ' + errormessage.responseText,
                    showConfirmButton: false,
                    timer: 2000
                });
                ObtienePersonas();
            }
        });

    }

    function ConfirmarAgregar()
    {
        Swal.fire({
            title: "Agregar",
            text: "¿Desea Agregar el Regitro?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: "Sí, Agregar",
            cancelButtonText: "Cancelar",
        })
        .then(resultado => {
            if (resultado.isConfirmed) { Agregar(); }
            else { ObtienePersonas(); }
        });
    }

    function Agregar()
    {
        var val = ValidaControles();
        if (val == false)
        {
            return false;
        }  
        var oPersona =
        {
            Nombre: $('#Nombre').val(),
            ApellidoPaterno: $('#ApellidoPaterno').val(),
            ApellidoMaterno: $('#ApellidoMaterno').val(),
            Estatus: $('#Estatus').val()
        };
        $.ajax({
            url: "/Personas/AgregarPersona1",
            data: JSON.stringify(oPersona),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                Swal.fire({
                    icon: 'success',
                    //title: 'Registro Agregado Correctamente ' + result.Resultado,
                    title: 'Registro Agregado Correctamente',
                    showConfirmButton: false,
                    timer: 2000
                });
                ObtienePersonas();
                $('#myModal').modal('hide');
            },
            error: function (errormessage)
            {
                Swal.fire({
                    icon: 'error',
                    title: 'Algo salio mal. Error' + errormessage.responseText,
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    }

    function Agregar2()
    {
        fetch("@Url.Content("~/Personas/AgregarPersona1")",
            {
                method: "POST",
                body: JSON.stringify({
                                        Nombre: document.getElementById("Nombre").value,
                                        ApellidoPaterno: document.getElementById("ApellidoPaterno").value,
                                        ApellidoMaterno: document.getElementById("ApellidoMaterno").value,
                                        Estatus: document.getElementById("Estatus").value
                                    }),
                headers:{
                            'Accept': "application/json",
                            "Content-Type": "application/json"
                        }
            }).then(function (response)
            {
                if (response.ok)
                {
                    return response.text();
                }
                else
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'Algo salio mal al conectar',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            })
            .then(function (Data)
            {
                if (Data == "1")
                {
                    Swal.fire({
                        icon: 'success',
                        title: 'Registro Agregado Correctamente',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    ObtienePersonas();
                    $('#myModal').modal('hide');
                }
                else
                {
                    Swal.fire({
                        icon: 'error',
                        title: 'No se agrego el registro',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            })
    }

    function ObtienePersona(Id)
    {
        $('#Nombre').css('border-color', 'lightgrey');
        $('#ApellidoPaterno').css('border-color', 'lightgrey');
        $('#ApellidoMaterno').css('border-color', 'lightgrey');

        Botones(0);

        $.ajax({

            url: "@Url.Content("~/Personas/ObtienePersona")",
            data: JSON.stringify({ Id: Id }),
            type: "POST",
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: function (result)
            {
                $('#Id').val(result.Id);
                $('#Nombre').val(result.Nombre);
                $('#ApellidoPaterno').val(result.ApellidoPaterno);
                $('#ApellidoMaterno').val(result.ApellidoMaterno);
                $('#Estatus').val(result.Estatus);

                $('#myModal').modal('show');
               
            },
            error: function (errormessage)
            {
                Swal.fire({
                    icon: 'error',
                    title: 'Algo salio mal. Error' + errormessage.responseText,
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    }

    function ConfirmarEdicion()
    {
        Swal.fire({
            title: "Editar",
            text: "¿Desea Editar el Registro?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: "Sí, Editar",
            cancelButtonText: "Cancelar",
        })
            .then(resultado => {
                if (resultado.isConfirmed) { Editar(); }
                else { ObtienePersonas(); }
            });
    }

    function Editar() {
        var val = ValidaControles();
        if (val == false) {
            return false;
        }
        var oPersona =
        {
            Id: $('#Id').val(),
            Nombre: $('#Nombre').val(),
            ApellidoPaterno: $('#ApellidoPaterno').val(),
            ApellidoMaterno: $('#ApellidoMaterno').val(),
            Estatus: $('#Estatus').val()
        };
        $.ajax({
            url: "/Personas/ActualizarPersona",
            data: JSON.stringify(oPersona),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                Swal.fire({
                    icon: 'success',
                    //title: 'Registro Agregado Correctamente ' + result.Resultado,
                    title: 'Registro Actualizado Correctamente',
                    showConfirmButton: false,
                    timer: 2000
                });
                ObtienePersonas();
                $('#myModal').modal('hide');
            },
            error: function (errormessage) {
                Swal.fire({
                    icon: 'error',
                    title: 'Algo salio mal. Error' + errormessage.responseText,
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    }

</script>

<div class="container">

    <h2>Personas</h2>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" onclick="Limpiar();">Agregar</button><br /><br />

    <table class="table table table-responsive table-striped table-bordered">
        <thead>
            <tr>
                <th>No</th>
                <th>Nombre</th>
                <th>Apellido Paterno</th>
                <th>Apellido Materno</th>
                <th>Estatus</th>
                <th>Editar / Eliminar</th>
            </tr>
        </thead>
        <tbody class="tbody">
        </tbody>
    </table>

</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                @*<button type="button" class="close" data-dissmiss="modal"><span aria-hidden="true">&times;</span></button>*@
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Agregar Persona</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-horizontal">
                        <h4>Persona</h4>
                        <hr />

                        @Html.HiddenFor(model => model.Id, new { Id = "Id" })

                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                        <div class="form-group">
                            <div class="col-md-10">
                                @Html.LabelFor(model => model.Nombre, htmlAttributes: new { @class = "control-label" })
                            </div>
                            <div class="col-md-10">
                                @Html.EditorFor(model => model.Nombre, new { htmlAttributes = new { @class = "form-control", id = "Nombre" } })
                                @Html.ValidationMessageFor(model => model.Nombre, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-10">
                                @Html.LabelFor(model => model.ApellidoPaterno, htmlAttributes: new { @class = "control-label" })
                            </div>
                            <div class="col-md-10">
                                @Html.EditorFor(model => model.ApellidoPaterno, new { htmlAttributes = new { @class = "form-control", id = "ApellidoPaterno" } })
                                @Html.ValidationMessageFor(model => model.ApellidoPaterno, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-10">
                                @Html.LabelFor(model => model.ApellidoMaterno, htmlAttributes: new { @class = "control-label" })
                            </div>
                            <div class="col-md-10">
                                @Html.EditorFor(model => model.ApellidoMaterno, new { htmlAttributes = new { @class = "form-control", id = "ApellidoMaterno" } })
                                @Html.ValidationMessageFor(model => model.ApellidoMaterno, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-10">
                                @Html.LabelFor(model => model.Estatus, htmlAttributes: new { @class = "control-label" })
                            </div>
                            <div class="col-md-10">
                                <div class="custom-control custom-checkbox">

                                    @Html.CheckBoxFor(model => model.Estatus, htmlAttributes: new { @class = "custom-control-input", id = "Estatus", onclick = "Check()", Checked = true })

                                    @Html.ValidationMessageFor(model => model.Estatus, "", new { @class = "text-danger" })

                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="ConfirmarAgregar" onclick="ConfirmarAgregar();">Aceptar</button>
                <button type="button" class="btn btn-primary" id="ConfirmarEditar" onclick="ConfirmarEdicion();">Aceptar</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

